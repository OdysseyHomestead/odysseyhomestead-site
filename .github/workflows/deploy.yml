# .github/workflows/deploy.yml
name: Manual Deploy to VPS

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Which branch to deploy'
        required: true
        default: 'main'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: Install & build
        run: |
          npm ci
          npm run build

      - name: Install rsync and SSH client
        run: sudo apt-get update && sudo apt-get install -y rsync openssh-client

      - name: Deploy build/ to VPS
        env:
          DEPLOY_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_USER:   ${{ secrets.VPS_USER }}
          VPS_HOST:   ${{ secrets.VPS_HOST }}
          TARGET_DIR: ${{ secrets.VPS_DEPLOY_PATH }}
        run: |
          # Write private key and lock down permissions
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          # Copy built files
          rsync -e "ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no" \
                -avz --delete build/ \
                "$VPS_USER@$VPS_HOST:$TARGET_DIR"

      - name: Reload Nginx on VPS
        env:
          DEPLOY_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_USER:   ${{ secrets.VPS_USER }}
          VPS_HOST:   ${{ secrets.VPS_HOST }}
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no \
              "$VPS_USER@$VPS_HOST" \
              "sudo systemctl reload nginx"
