# .github/workflows/deploy.yml

name: Manual Deploy to VPS

# Only runs when you click “Run workflow” in the Actions UI
on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Which branch to deploy'
        required: true
        default: 'main'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout your repo at the selected branch
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.branch }}

      # 2) Install Node deps & build the React app
      - name: Install & build
        run: |
          npm ci
          npm run build

      # 3) Install rsync + SSH client
      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y rsync openssh-client

      # 4) Deploy build/ to your VPS
      - name: Deploy build to VPS
        env:
          DEPLOY_KEY:     ${{ secrets.VPS_SSH_KEY }}
          VPS_USER:       ${{ secrets.VPS_USER }}
          VPS_HOST:       ${{ secrets.VPS_HOST }}
          TARGET_DIR:     ${{ secrets.VPS_DEPLOY_PATH }}
        run: |
          # Prepare SSH folder
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Trust the VPS host key
          ssh-keyscan -H "$VPS_HOST" >> ~/.ssh/known_hosts

          # Write and secure the private key
          echo "$DEPLOY_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          # Sync the build directory
          rsync -e "ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes" \
                -avz --delete build/ \
                "${VPS_USER}@${VPS_HOST}:${TARGET_DIR}"

      # 5) Reload Nginx on the VPS
      - name: Reload Nginx
        env:
          DEPLOY_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_USER:   ${{ secrets.VPS_USER }}
          VPS_HOST:   ${{ secrets.VPS_HOST }}
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes \
              "${VPS_USER}@${VPS_HOST}" \
              "sudo systemctl reload nginx"
