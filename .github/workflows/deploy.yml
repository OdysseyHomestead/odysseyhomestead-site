name: Manual Deploy to VPS

# Triggers: 
#  - workflow_dispatch lets you hit "Run workflow" in the Actions UI  
#  - push on main (optionalâ€”remove if you only want manual)
on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Which branch to deploy'
        required: true
        default: 'main'
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. Check out the code at the selected branch
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.branch || github.ref_name }}

      # 2. Install dependencies & build the React app
      - name: Install & build
        run: |
          npm ci
          npm run build

      # 3. Deploy build/ to your VPS via rsync
      - name: Deploy to VPS
        uses: burnett01/rsync-deployments@v3
        with:
          switches: -avz --delete
          path: build/
          remote_host: ${{ secrets.VPS_HOST }}
          remote_user: ${{ secrets.VPS_USER }}
          remote_path: ${{ secrets.VPS_DEPLOY_PATH }}
          key: ${{ secrets.VPS_SSH_KEY }}
          # Ensure ownership & reload Nginx after sync
          pre_cmd: sudo chown -R www-data:www-data ${{ secrets.VPS_DEPLOY_PATH }}
          post_cmd: sudo systemctl reload nginx
